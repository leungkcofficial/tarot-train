# TAROT CKD Risk Prediction - Docker Deployment Makefile

.PHONY: help build up down logs health test clean deploy stop restart

# Default target
help:
	@echo "ğŸ©º TAROT CKD Risk Prediction - Docker Deployment"
	@echo "================================================"
	@echo ""
	@echo "Available commands:"
	@echo "  make deploy     - Build and deploy all services (frontend on :3000, backend on :8000)"
	@echo "  make up         - Start services (without rebuild)"
	@echo "  make down       - Stop and remove containers"
	@echo "  make restart    - Restart all services"
	@echo "  make logs       - Show logs from all services"
	@echo "  make health     - Check service health"
	@echo "  make test       - Run deployment tests"
	@echo "  make clean      - Clean up Docker resources"
	@echo "  make stop       - Stop services without removing containers"
	@echo ""
	@echo "Quick start: make deploy && make health"

# Build and deploy all services
deploy:
	@echo "ğŸš€ Building and deploying TAROT CKD Risk Prediction..."
	docker-compose up --build -d
	@echo "âœ… Deployment complete!"
	@echo "   Frontend: http://localhost:3000"
	@echo "   Backend:  http://localhost:8000"
	@echo "   API Docs: http://localhost:8000/docs"

# Start services without rebuild
up:
	@echo "â¬†ï¸  Starting services..."
	docker-compose up -d

# Stop and remove containers
down:
	@echo "â¬‡ï¸  Stopping and removing containers..."
	docker-compose down

# Stop services without removing containers
stop:
	@echo "â¹ï¸  Stopping services..."
	docker-compose stop

# Restart all services
restart:
	@echo "ğŸ”„ Restarting services..."
	docker-compose restart

# Show logs from all services
logs:
	@echo "ğŸ“‹ Service logs:"
	docker-compose logs -f --tail=50

# Check service health
health:
	@echo "ğŸ¥ Checking service health..."
	@echo "Frontend health:"
	@curl -s http://localhost:3000/health || echo "âŒ Frontend not responding"
	@echo ""
	@echo "Backend health:"
	@curl -s http://localhost:8000/health | python -m json.tool || echo "âŒ Backend not responding"
	@echo ""
	@echo "Service status:"
	docker-compose ps

# Run deployment readiness tests
test:
	@echo "ğŸ§ª Running deployment tests..."
	python ../test_docker_deployment.py 2>/dev/null || python /tmp/test_docker_deployment.py

# Clean up Docker resources
clean:
	@echo "ğŸ§¹ Cleaning up Docker resources..."
	docker-compose down -v
	docker system prune -f
	@echo "âœ… Cleanup complete"

# Build only (no deploy)
build:
	@echo "ğŸ”¨ Building Docker images..."
	docker-compose build --no-cache

# Production deployment with nginx
production:
	@echo "ğŸ­ Starting production deployment with nginx..."
	docker-compose --profile production up --build -d
	@echo "âœ… Production deployment complete!"
	@echo "   Access via: http://localhost/"

# Development mode (with file watching)
dev:
	@echo "ğŸ‘¨â€ğŸ’» Starting development mode..."
	docker-compose -f docker-compose.yml -f docker-compose.dev.yml up --build

# Show container resource usage
stats:
	@echo "ğŸ“Š Container resource usage:"
	docker stats --no-stream

# Backup models directory
backup-models:
	@echo "ğŸ’¾ Creating models backup..."
	tar -czf models-backup-$(shell date +%Y%m%d-%H%M%S).tar.gz ../foundation_models/
	@echo "âœ… Backup created"

# Quick smoke test
smoke-test:
	@echo "ğŸš¨ Running smoke test..."
	@echo "Testing frontend..."
	@curl -s http://localhost:3000 > /dev/null && echo "âœ… Frontend OK" || echo "âŒ Frontend failed"
	@echo "Testing backend..."
	@curl -s http://localhost:8000/health > /dev/null && echo "âœ… Backend OK" || echo "âŒ Backend failed"
	@echo "Testing API..."
	@curl -s http://localhost:8000/api/v1/health > /dev/null && echo "âœ… API OK" || echo "âŒ API failed"